package Menu;

import Model.*;
import Service.*;
import java.util.*;

public class MenuPetugas {
    private final Scanner input = new Scanner(System.in);
    private final Laporan laporan = new Laporan();
    private final RekamMedisDokter service = new RekamMedisDokter();
    private final ServiceUser registrasi = new ServiceUser();

    
    public void tampilMenu(Petugas petugas) {
        int pilihan;
        do {
            System.out.println("\n=== MENU PETUGAS ===");
            System.out.println("Selamat datang, " + petugas.getNama());
            System.out.println("1. Dashboard");
            System.out.println("2. Laporan Kesehatan");
            System.out.println("3. Rekam Medis");
            System.out.println("4. Kelola Akun");
            System.out.println("5. Logout");
            System.out.print("Pilih: ");
            
            try {
                pilihan = Integer.parseInt(input.nextLine());
            } catch (NumberFormatException e) {
                System.out.println("Input harus berupa angka!");
                pilihan = 0;
                continue;
            }

            switch (pilihan) {
                case 1:
                    tampilDashboard(petugas);
                    break;

                case 2:
                    tampilMenuLaporan(petugas);
                    break;

                case 3:
                    lihatSemuaRekamMedis();
                    break;

                case 4:
                    menuKelolaAkun(petugas);
                    break;

                case 5:
                    System.out.println("Logout...");
                    break;

                default:
                    System.out.println("âŒ Pilihan tidak valid, coba lagi!");
            }
        } while (pilihan != 5);
    }

    // âœ… DASHBOARD (Coming Soon)
    private void tampilDashboard(Petugas petugas) {
        System.out.println("\n=== DASHBOARD ===");
        System.out.println("Fitur dashboard akan segera hadir!");
        System.out.println("Tekan Enter untuk kembali...");
        input.nextLine();
    }

    // MENU KELOLA AKUN (REGISTRASI)

    private void menuKelolaAkun(Petugas petugas) {
        int pilihan;
        do {
            System.out.println("\n=== KELOLA AKUN ===");
            System.out.println("1. Daftar Petugas Baru");
            System.out.println("2. Daftar Dokter Baru");
            System.out.println("3. Kembali");
            System.out.print("Pilih: ");
            
            try {
                pilihan = Integer.parseInt(input.nextLine());
            } catch (NumberFormatException e) {
                System.out.println("âŒ Input harus berupa angka!");
                pilihan = 0;
                continue;
            }

            switch (pilihan) {
                case 1:
                    daftarPetugasBaru(petugas);
                    break;
                case 2:
                    daftarDokterBaru(petugas);
                    break;
                case 3:
                    System.out.println("Kembali ke menu utama...");
                    return;
                default:
                    System.out.println("âŒ Pilihan tidak valid!");
            }
        } while (pilihan != 3);
    }

    private void daftarPetugasBaru(Petugas petugas) {
        try {
            System.out.println("\n=== DAFTAR PETUGAS BARU ===");
            
            System.out.print("Username: ");
            String username = input.nextLine();

            if (registrasi.isUsernameExist(username)) {
                System.out.println("âŒ Username sudah digunakan! Gunakan username lain.");
                return;
            }

            System.out.print("Password: ");
            String password = input.nextLine();

            System.out.print("Nama Petugas: ");
            String nama = input.nextLine();

            System.out.print("Bagian (contoh: Administrasi, Pelayanan): ");
            String bagian = input.nextLine();

            int idPuskesmas = petugas.getIdPuskesmas();
            registrasi.daftarPetugas(username, password, idPuskesmas, nama, bagian);

        } catch (Exception e) {
            System.out.println("âŒ Kesalahan input: " + e.getMessage());
        }
    }

    private void daftarDokterBaru(Petugas petugas) {
        try {
            System.out.println("\n=== DAFTAR DOKTER BARU ===");
            
            System.out.print("Username: ");
            String username = input.nextLine();

            if (registrasi.isUsernameExist(username)) {
                System.out.println("âŒ Username sudah digunakan! Gunakan username lain.");
                return;
            }

            System.out.print("Password: ");
            String password = input.nextLine();

            System.out.print("Nama Dokter: ");
            String nama = input.nextLine();

            System.out.print("Spesialis (contoh: Umum, Geriatri): ");
            String spesialis = input.nextLine();

            int idPuskesmas = petugas.getIdPuskesmas();
            registrasi.daftarDokter(username, password, idPuskesmas, nama, spesialis);

        } catch (Exception e) {
            System.out.println("âŒ Kesalahan input: " + e.getMessage());
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MENU LAPORAN KESEHATAN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    public void tampilMenuLaporan(Petugas petugas) {
        int pilihan;
        do {
            System.out.println("\n=== MENU LAPORAN PETUGAS ===");
            System.out.println("Selamat datang, " + petugas.getNama());
            System.out.println("1. Tambah Laporan dan Lansia");
            System.out.println("2. Lihat Semua Laporan");
            System.out.println("3. Update Laporan");
            System.out.println("4. Hapus Laporan");
            System.out.println("5. Cari Laporan");
            System.out.println("6. Kembali");
            System.out.print("Pilih: ");
            
            try {
                pilihan = Integer.parseInt(input.nextLine());
            } catch (NumberFormatException e) {
                System.out.println("âŒ Input harus berupa angka!");
                pilihan = 0;
                continue;
            }

            switch (pilihan) {
                case 1:
                    tambahLaporanDanLansia(petugas);
                    break;

                case 2:
                    lihatSemuaLaporan();
                    break;

                case 3:
                    ubahLaporan();
                    break;

                case 4:
                    hapusLaporan();
                    break;

                case 5:
                    cariLaporan();
                    break;

                case 6:
                    System.out.println("Kembali...");
                    return;

                default:
                    System.out.println("âŒ Pilihan tidak valid, coba lagi!");
            }
        } while (pilihan != 6);
    }

    private void tambahLaporanDanLansia(Petugas petugas) {
        try {
            System.out.println("\n=== TAMBAH DATA LANSIA DAN LAPORAN ===");
            System.out.print("Nama Lansia: ");
            String nama = input.nextLine();
            
            System.out.print("Usia: ");
            int usia = Integer.parseInt(input.nextLine());
            
            System.out.print("Jenis Kelamin: ");
            String jk = input.nextLine();
            
            System.out.print("Alamat: ");
            String alamat = input.nextLine();
            
            System.out.print("Keluhan: ");
            String keluhan = input.nextLine();
            
            System.out.print("Tindakan: ");
            String tindakan = input.nextLine();

            Lansia lansia = new Lansia(0, nama, usia, jk, alamat);
            LaporanKesehatan lap = new LaporanKesehatan(0, null, keluhan, tindakan, petugas.getId(), lansia);

            laporan.tambahLaporanDanLansia(lansia, lap);
        } catch (NumberFormatException e) {
            System.out.println("âŒ Usia harus berupa angka!");
        } catch (Exception e) {
            System.out.println("âŒ Kesalahan input: " + e.getMessage());
        }
    }
    
    // âœ… LIHAT SEMUA LAPORAN (Format Tabel)
    private void lihatSemuaLaporan() {
        List<LaporanKesehatan> list = laporan.lihatSemuaLaporan();
        if (list.isEmpty()) {
            System.out.println("ğŸ“‹ Belum ada data laporan.");
            return;
        }

        System.out.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘                                    DAFTAR LAPORAN KESEHATAN                                      â•‘");
        System.out.println("â• â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
        System.out.println("â•‘ ID     â•‘ Tanggal      â•‘ Nama Lansia           â•‘ Keluhan               â•‘ Tindakan                  â•‘");
        System.out.println("â• â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
        
        for (LaporanKesehatan l : list) {
            Lansia ln = l.getLansia();
            System.out.printf("â•‘ %-6d â•‘ %-12s â•‘ %-21s â•‘ %-21s â•‘ %-25s â•‘%n",
                l.getIdLaporan(),
                l.getTanggalPeriksa(),
                truncate(ln.getNama(), 21),
                truncate(l.getKeluhan(), 21),
                truncate(l.getTindakan(), 25)
            );
        }
        
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        System.out.println("Total: " + list.size() + " laporan");
    }

    private void ubahLaporan() {
        try {
            System.out.println("\n=== UPDATE LAPORAN ===");
            System.out.print("Masukkan ID Laporan: ");
            int id = Integer.parseInt(input.nextLine());
            
            System.out.print("Keluhan baru: ");
            String keluhan = input.nextLine();
            
            System.out.print("Tindakan baru: ");
            String tindakan = input.nextLine();
            
            laporan.ubahLaporanKesehatan(id, keluhan, tindakan);
        } catch (NumberFormatException e) {
            System.out.println("âŒ ID Laporan harus berupa angka!");
        } catch (Exception e) {
            System.out.println("âŒ Kesalahan input: " + e.getMessage());
        }
    }

    private void hapusLaporan() {
        try {
            System.out.println("\n=== HAPUS LAPORAN ===");
            System.out.print("Masukkan ID Laporan: ");
            int id = Integer.parseInt(input.nextLine());
            
            System.out.print("Apakah Anda yakin ingin menghapus? (y/n): ");
            String konfirmasi = input.nextLine();
            
            if (konfirmasi.equalsIgnoreCase("y")) {
                laporan.hapusLaporanKesehatan(id);
            } else {
                System.out.println("âš ï¸ Penghapusan dibatalkan.");
            }
        } catch (NumberFormatException e) {
            System.out.println("âŒ ID Laporan harus berupa angka!");
        } catch (Exception e) {
            System.out.println("âŒ Kesalahan input: " + e.getMessage());
        }
    }

    // âœ… CARI LAPORAN (Format Tabel)
    private void cariLaporan() {
        System.out.println("\n=== CARI LAPORAN ===");
        System.out.print("Masukkan nama lansia: ");
        String nama = input.nextLine();
        
        if (nama.trim().isEmpty()) {
            System.out.println("âŒ Nama tidak boleh kosong!");
            return;
        }
        
        List<LaporanKesehatan> hasil = laporan.cariLaporanByNamaLansia(nama);

        if (hasil.isEmpty()) {
            System.out.println("ğŸ“‹ Tidak ada laporan untuk nama tersebut.");
            return;
        }

        System.out.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘                                HASIL PENCARIAN LAPORAN KESEHATAN                                 â•‘");
        System.out.println("â• â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
        System.out.println("â•‘ ID     â•‘ Tanggal      â•‘ Nama Lansia           â•‘ Keluhan               â•‘ Tindakan                  â•‘");
        System.out.println("â• â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
        
        for (LaporanKesehatan l : hasil) {
            Lansia ln = l.getLansia();
            System.out.printf("â•‘ %-6d â•‘ %-12s â•‘ %-21s â•‘ %-21s â•‘ %-25s â•‘%n",
                l.getIdLaporan(),
                l.getTanggalPeriksa(),
                truncate(ln.getNama(), 21),
                truncate(l.getKeluhan(), 21),
                truncate(l.getTindakan(), 25)
            );
        }
        
        System.out.println("â•šâ•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        System.out.println("Total: " + hasil.size() + " laporan ditemukan");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REKAM MEDIS (READ-ONLY untuk Petugas)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private void lihatSemuaRekamMedis() {
        List<RekamMedis> list = service.lihatSemuaRekamMedis();
        if (list.isEmpty()) {
            System.out.println("ğŸ“‹ Belum ada data rekam medis.");
            return;
        }

        System.out.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        System.out.println("â•‘                                           DAFTAR REKAM MEDIS                                                       â•‘");
        System.out.println("â• â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
        System.out.println("â•‘ ID    â•‘ Tanggal      â•‘ Nama Lansia           â•‘ Diagnosis             â•‘ Tindakan              â•‘ ID Dokter             â•‘");
        System.out.println("â• â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
        
        for (RekamMedis rm : list) {
            Lansia ln = rm.getLansia();
            System.out.printf("â•‘ %-5d â•‘ %-12s â•‘ %-21s â•‘ %-21s â•‘ %-21s â•‘ %-21dâ•‘%n",
                rm.getIdRekam(),
                rm.getTanggalPemeriksaan(),
                truncate(ln != null ? ln.getNama() : "-", 21),
                truncate(rm.getDiagnosis(), 21),
                truncate(rm.getTindakan(), 21),
                rm.getIdDokter()
            );
        }
        
        System.out.println("â•šâ•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        System.out.println("Total: " + list.size() + " rekam medis");
    }

    // âœ… HELPER - Truncate string untuk fit di tabel
    private String truncate(String text, int maxLength) {
        if (text == null) return "";
        if (text.length() <= maxLength) return text;
        return text.substring(0, maxLength - 3) + "...";
    }
}
